<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ח.סבן</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #075E54; --secondary: #128C7E; --accent: #25D366; --bg: #ECE5DD;
            --app-bg: #f7f7f7; --text-dark: #333; --border: #e0e0e0;
            --outgoing-bg: #dcf8c6; --incoming-bg: #ffffff;
            --header-height: 60px; --nav-height: 50px;
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Assistant', sans-serif; background-color: var(--primary); }
        .app-shell { display: flex; flex-direction: column; height: 100%; max-width: 800px; margin: 0 auto; background-color: var(--bg); }
        
        /* Header */
        .app-header {
            display: flex; align-items: center; justify-content: space-between;
            background-color: var(--primary); color: white;
            padding: 0 15px; height: var(--header-height);
        }
        .header-left { display: flex; align-items: center; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #fff; margin-left: 10px; }
        .header-title { font-size: 1.2rem; font-weight: 600; }
        .header-menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

        /* Nav Tabs */
        .app-nav { display: flex; background-color: var(--primary); height: var(--nav-height); }
        .nav-tab {
            flex: 1; display: flex; align-items: center; justify-content: center;
            color: rgba(255,255,255,0.7); text-decoration: none; font-weight: 600;
            border-bottom: 3px solid transparent; transition: all 0.3s;
        }
        .nav-tab.active { color: white; border-bottom-color: var(--accent); }

        /* Page Container */
        .page-container { flex: 1; position: relative; overflow: hidden; }
        .page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg); overflow-y: auto;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        .page.active { transform: translateX(0); }
        .page.rtl-exit { transform: translateX(-100%); }
        
        /* Chat Page Styles */
        #page-chat { display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .chat-canvas { flex: 1; padding: 15px; }
        .message-bubble { max-width: 85%; padding: 10px 15px; border-radius: 12px; margin-bottom: 12px; line-height: 1.5; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); animation: popIn 0.3s ease-out; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .message-bubble.outgoing { background-color: var(--outgoing-bg); margin-left: auto; }
        .message-bubble.incoming { background-color: var(--incoming-bg); margin-right: auto; }
        .buttons-container { display: flex; gap: 8px; margin-top: 10px; }
        .quick-reply-btn { background-color: #fff; border: 1px solid var(--secondary); color: var(--secondary); padding: 8px 12px; border-radius: 20px; cursor: pointer; }
        .chat-input-area { display: flex; padding: 10px; background-color: #f0f0f0; }
        .chat-input { flex: 1; border: 1px solid #ccc; border-radius: 20px; padding: 10px 15px; font-size: 1rem; }
        
        /* Other Pages Styles */
        .content-padding { padding: 20px; }
        .list-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .list-item h3 { margin: 0 0 10px 0; }
        
        .fab { position: fixed; bottom: 80px; left: 20px; width: 56px; height: 56px; background-color: var(--accent); border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.2); font-size: 1.5rem; color: white; cursor: pointer; transform: scale(0); transition: transform 0.3s; }
        .fab.visible { transform: scale(1); }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="app-header">
            <div class="header-left">
                <img src="https://i.postimg.cc/2SbDgD1B/1.png" class="avatar">
                <h1 class="header-title" id="header-title">הזמנה חדשה</h1>
            </div>
            <button class="header-menu-btn"><i class="fa fa-ellipsis-v"></i></button>
        </header>

        <nav class="app-nav">
            <a href="#chat" class="nav-tab active" data-page="page-chat">צ'אט</a>
            <a href="#projects" class="nav-tab" data-page="page-projects">פרויקטים</a>
            <a href="#orders" class="nav-tab" data-page="page-orders">הזמנות</a>
            <a href="#reports" class="nav-tab" data-page="page-reports">דוחות</a>
        </nav>

        <main class="page-container">
            <!-- Page 1: Chat for New Order -->
            <div id="page-chat" class="page active">
                <div class="chat-canvas" id="chat-canvas"></div>
                <div class="chat-input-area">
                    <input type="text" id="message-input" class="chat-input" placeholder="הקלד/י הודעה...">
                    <button id="send-btn">➡️</button>
                </div>
            </div>
            <!-- Page 2: Projects -->
            <div id="page-projects" class="page">
                <div class="content-padding" id="projects-content">טוען פרויקטים...</div>
            </div>
            <!-- Page 3: Orders History -->
            <div id="page-orders" class="page">
                 <div class="content-padding" id="orders-content">טוען היסטוריית הזמנות...</div>
            </div>
            <!-- Page 4: Reports -->
            <div id="page-reports" class="page">
                 <div class="content-padding">
                    <h2>ניתוח הזמנות</h2>
                    <canvas id="ordersChart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <button id="fab" class="fab">🚀</button>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxsza_jsirK2cQRTpp4mNMGj76qlVbLyVPLMgIGxdBdkY3S1DQ4UtNGk4VMMpRfnmbI/exec';
        // --- STATE & DOM ---
        const state = { /* ... (same as before) ... */ };
        const dom = { /* ... (same as before, plus new elements) ... */ };
        // (For brevity, assuming previous state and dom objects are here)
        
        // --- NEW NAVIGATION & PAGE LOGIC ---
        function setupNavigation() {
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = e.currentTarget.dataset.page;
                    navigateTo(pageId);
                    
                    tabs.forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });
        }
        
        function navigateTo(pageId) {
            const pages = document.querySelectorAll('.page');
            const targetPage = document.getElementById(pageId);
            const currentPage = document.querySelector('.page.active');

            if (currentPage && currentPage.id !== pageId) {
                currentPage.classList.remove('active');
                currentPage.classList.add('rtl-exit');
                setTimeout(() => currentPage.classList.remove('rtl-exit'), 400);
            }
            
            targetPage.classList.add('active');
            document.getElementById('header-title').textContent = document.querySelector(`.nav-tab[data-page="${pageId}"]`).textContent;

            // Load page content
            if (pageId === 'page-projects' || pageId === 'page-orders' || pageId === 'page-reports') {
                loadDashboardData();
            }
        }
        
        async function loadDashboardData() {
            const content = await apiPost({ action: 'getClientDashboardData', clientId: state.clientId });
            if(content.success) {
                renderProjectsPage(content.data.projects, content.data.orders);
                renderOrdersPage(content.data.orders);
                renderReportsPage(content.data.orders);
            }
        }
        
        function renderProjectsPage(projects, orders) {
             const container = document.getElementById('projects-content');
             container.innerHTML = '<h3>הפרויקטים שלי</h3>';
             projects.forEach(p => {
                 const projectOrders = orders.filter(o => o.project === p['שם_פרויקט']);
                 let ordersHtml = projectOrders.map(o => `<li>הזמנה ${o.orderId} - ${o.status}</li>`).join('');
                 container.innerHTML += `
                    <div class="list-item">
                        <h3>${p['שם_פרויקט']}</h3>
                        <p>${p['כתובת']}</p>
                        <ul>${ordersHtml || '<li>אין הזמנות לפרויקט זה.</li>'}</ul>
                    </div>
                 `;
             });
        }

        function renderOrdersPage(orders) {
            const container = document.getElementById('orders-content');
            container.innerHTML = '<h3>היסטוריית הזמנות</h3>';
            orders.forEach(o => {
                container.innerHTML += `
                    <div class="list-item">
                        <h3>הזמנה ${o.orderId} <span style="font-size: 0.8em; color: #666;">(${o.date})</span></h3>
                        <p><strong>סטטוס:</strong> ${o.status}</p>
                        <p><strong>פריטים:</strong> ${JSON.parse(o.items).length} סוגים</p>
                    </div>
                `;
            });
        }

        function renderReportsPage(orders) {
            const ctx = document.getElementById('ordersChart').getContext('2d');
            const monthlyData = orders.reduce((acc, order) => {
                const month = new Date(order.date).toLocaleString('he-IL', { month: 'long', year: 'numeric' });
                acc[month] = (acc[month] || 0) + 1;
                return acc;
            }, {});

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(monthlyData),
                    datasets: [{
                        label: 'מספר הזמנות בחודש',
                        data: Object.values(monthlyData),
                        backgroundColor: 'rgba(37, 211, 102, 0.5)',
                        borderColor: 'rgba(37, 211, 102, 1)',
                        borderWidth: 1
                    }]
                },
                options: { responsive: true }
            });
        }

        // --- EXISTING CHAT LOGIC ---
        // All previous functions (init, fetchClient, loadProducts, conversationManager, etc.) are assumed to be here.
        // A small modification is needed for the conversation manager to handle status checks.

        function conversationManager(userInput = null, payload = null) {
            if (userInput && (userInput.includes('סטטוס') || userInput.includes('מצב הזמנה'))) {
                handleStatusRequest(userInput);
                return;
            }
            // ... (rest of the switch-case logic from previous version)
        }
        
        async function handleStatusRequest(userInput) {
            const orderIdMatch = userInput.match(/SBN-\d+/);
            if (orderIdMatch) {
                const orderId = orderIdMatch[0];
                renderUserMessage(userInput);
                const res = await apiPost({ action: 'getOrderStatus', orderId: orderId });
                if (res.success) {
                    renderBotMessage(`סטטוס הזמנה ${orderId} הוא: *${res.status}*.`);
                } else {
                    renderBotMessage(`לא מצאתי הזמנה במספר ${orderId}.`);
                }
            } else {
                renderBotMessage("כדי לבדוק סטטוס, אנא רשום את מספר ההזמנה המלא (לדוגמה: מה הסטטוס של SBN-12345?).");
            }
        }
        
        // --- INITIALIZATION ---
        function init() {
            // ... (previous init logic)
            setupNavigation(); // Add this line to initialize tabs
        }
        
        // --- Call init ---
        // init();
        // (The full script from the previous turn would be integrated here)
    </script>
</body>
</html>

