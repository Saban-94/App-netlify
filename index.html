<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>העוזר האישי להזמנות - ח.סבן</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/2SbDgD1B/1.png">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #e5ddd5; --app-bg: #f7f7f7;
            --text-dark: #333; --text-light: #666; --border: #e0e0e0;
            --outgoing-bg: #dcf8c6; --incoming-bg: #ffffff; --system-bg: #e1f2fb;
            --radius-l: 20px; --radius-s: 8px; --shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; }
        body { font-family: 'Assistant', sans-serif; background-color: var(--bg); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); display: flex; align-items: center; justify-content: center; }

        .app-shell { width: 100%; height: 100%; max-width: 450px; background-color: var(--app-bg); display: flex; flex-direction: column; box-shadow: var(--shadow); transition: all 0.3s ease; }
        @media (min-width: 450px) { .app-shell { max-height: 95vh; border-radius: var(--radius-l); } }

        .chat-header { flex-shrink: 0; display: flex; align-items: center; gap: 15px; padding: 10px 15px; background-color: #f0f0f0; border-bottom: 1px solid var(--border); }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background-color: var(--brand); overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .header-info h1 { font-size: 1.1rem; font-weight: 700; color: var(--text-dark); }
        .header-info p { font-size: 0.8rem; color: var(--text-light); }

        .chat-canvas { flex-grow: 1; overflow-y: auto; padding: 20px 15px; display: flex; flex-direction: column; gap: 12px; }
        
        .message-bubble { display: flex; flex-direction: column; max-width: 85%; padding: 10px 15px; border-radius: var(--radius-l); line-height: 1.5; animation: popIn 0.3s ease-out; }
        .message-bubble.outgoing { background-color: var(--outgoing-bg); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-bubble.incoming { background-color: var(--incoming-bg); align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-bubble .timestamp { font-size: 0.7rem; color: var(--text-light); opacity: 0.7; margin-top: 5px; text-align: left; }
        .message-bubble.incoming .timestamp { text-align: right; }
        .seen-tick { font-weight: 700; color: #4fc3f7; margin-left: 3px; }
        
        .system-message { align-self: center; background-color: var(--system-bg); color: #026198; font-size: 0.85rem; padding: 8px 12px; border-radius: var(--radius-l); text-align: center; animation: popIn 0.3s; }
        .typing-indicator { align-self: flex-start; padding: 10px 15px; background-color: var(--incoming-bg); border-radius: var(--radius-l); display: flex; gap: 5px; }
        .typing-indicator span { width: 8px; height: 8px; border-radius: 50%; background-color: #ccc; animation: typing 1.2s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .chat-footer { flex-shrink: 0; display: flex; align-items: center; gap: 10px; padding: 10px; background-color: #f0f0f0; border-top: 1px solid var(--border); }
        #message-input { flex-grow: 1; border: none; padding: 12px 15px; border-radius: var(--radius-l); font-family: inherit; font-size: 1rem; resize: none; }
        .footer-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background-color: var(--brand); color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
        .footer-btn:active { transform: scale(0.9); }
        
        .order-preview-card { background-color: #fefefe; border: 1px solid var(--border); border-radius: var(--radius-s); padding: 15px; margin-top: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .order-preview-card h3 { font-size: 1rem; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 10px; }
        .product-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px dashed #eee; }
        .product-item.unidentified { background-color: #fff8e1; }
        .product-item input { width: 60px; text-align: center; border: 1px solid var(--border); border-radius: 4px; padding: 4px; }
        .item-name { flex-grow: 1; }
        .item-name.unidentified-item { color: var(--accent); font-weight: 600; }
        .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .action-buttons button { flex-grow: 1; padding: 10px; border-radius: var(--radius-s); border: 1px solid var(--brand); cursor: pointer; font-weight: 700; background-color: #fff; color: var(--brand); }
        .btn-confirm { background-color: var(--success); color: white; border: none;}
        .btn-cancel { background-color: var(--text-light); color: white; border: none;}

        #spinner-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.7); display: none; align-items: center; justify-content: center; z-index: 10; flex-direction: column; gap: 10px; color: var(--brand); font-weight: 600; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top-color: var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .image-attachment { max-width: 100%; border-radius: var(--radius-s); margin-top: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="app-shell">
        <header class="chat-header">
            <div class="avatar"><img id="rep-avatar" src="https://i.postimg.cc/Fs3pXm2c/1.png" alt="נציג"></div>
            <div class="header-info">
                <h1 id="rep-name">ראמי (עוזר אישי)</h1>
                <p>זמין 24/7 לשירותך</p>
            </div>
        </header>

        <main class="chat-canvas" id="chat-canvas">
            <!-- Messages will be injected here by JavaScript -->
        </main>

        <footer class="chat-footer">
            <button class="footer-btn" id="send-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/></svg>
            </button>
            <textarea id="message-input" placeholder="הקלד או הדבק רשימה..." rows="1"></textarea>
            <button class="footer-btn" id="attach-btn" title="צרף תמונה">
                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.59a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
            </button>
            <input type="file" id="file-input" accept="image/*" style="display:none;">
        </footer>
        <div id="spinner-overlay"><div class="spinner"></div><span id="spinner-text"></span></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // This URL should point to your deployed Google Apps Script
            const API_URL = "https://script.google.com/macros/s/AKfycbzbo8jqgN7SBpU5xcARbNxcUwnYZc7ogcvp9XcYMM_lMr_og2mdkjLSA7C7gp0ptLzY/exec";

            const dom = {
                canvas: document.getElementById('chat-canvas'),
                input: document.getElementById('message-input'),
                sendBtn: document.getElementById('send-btn'),
                attachBtn: document.getElementById('attach-btn'),
                fileInput: document.getElementById('file-input'),
                spinner: document.getElementById('spinner-overlay'),
                spinnerText: document.getElementById('spinner-text'),
                repName: document.getElementById('rep-name'),
                repAvatar: document.getElementById('rep-avatar'),
            };

            let state = {
                user: { 'שם_לקוח': 'אורח' },
                chatHistory: [],
                isBotTyping: false,
                productCatalog: [],
            };
            
            async function init() {
                showSpinner("מתחבר...");
                try {
                    // In a real app, you'd get the identifier from a login screen
                    const identifier = '60120'; 
                    const response = await apiPost({ action: 'login', identifier });
                    
                    if (response.status === 'success') {
                        state.user = response.user;
                        state.chatHistory = response.chatHistory || [];
                        updateHeader(response.user);
                        renderChatHistory();
                        addMessageToCanvas({ sender: 'bot', text: getGreeting() });
                        loadProductCatalog();
                    } else {
                        throw new Error(response.message);
                    }
                } catch (e) {
                    console.error("Login failed:", e);
                    addMessageToCanvas({ sender: 'bot', text: 'שגיאה בהתחברות. נסה לרענן את העמוד.' });
                } finally {
                    hideSpinner();
                    setupEventListeners();
                }
            }
            
            function setupEventListeners() {
                dom.sendBtn.addEventListener('click', handleUserInput);
                dom.input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleUserInput(); }
                });
                dom.attachBtn.addEventListener('click', () => dom.fileInput.click());
                dom.fileInput.addEventListener('change', handleFileUpload);
                // Event delegation for dynamic buttons
                dom.canvas.addEventListener('click', (e) => {
                    const button = e.target.closest('button[data-payload]');
                    if (button) {
                        const payload = button.dataset.payload;
                        const text = button.textContent;
                        addMessageToCanvas({ sender: 'user', text: `בחרתי: ${text}` });
                        processMessage(payload); // Send payload for processing
                        // Disable buttons after click
                        button.parentElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
                    }
                });
            }

            function updateHeader(user) {
                dom.repName.textContent = user.אווטאר_נציג || "ראמי (עוזר אישי)";
                dom.repAvatar.src = user.תמונת_פרופיל || "https://i.postimg.cc/Fs3pXm2c/1.png";
            }

            function renderChatHistory() {
                dom.canvas.innerHTML = '';
                state.chatHistory.forEach(msg => {
                    const message = {
                        sender: msg.שולח === 'user' ? 'user' : 'bot',
                        text: msg.תוכן,
                        timestamp: new Date(msg.חותמת_זמן)
                    };
                    addMessageToCanvas(message, false); // false = don't animate
                });
            }
            
            async function loadProductCatalog() {
                 try {
                    // Assuming this action is implemented in your Code.js
                    const response = await apiPost({ action: 'getProductCatalog' });
                    if (response.status === 'success') state.productCatalog = response.catalog;
                 } catch (e) { console.error("Failed to load catalog", e); }
            }

            function getGreeting() {
                const hour = new Date().getHours();
                const name = state.user['שם_לקוח'] ? state.user['שם_לקוח'].split(' ')[0] : 'לקוח';
                if (hour < 12) return `בוקר טוב ${name} ☀️, אני העוזר האישי שלך. איך אפשר לעזור היום?`;
                if (hour < 18) return `צהריים טובים ${name} 🍽️, מוכן לקחת את ההזמנה שלך.`;
                return `ערב טוב ${name} 🌙, כאן לשירותך.`;
            }

            function handleUserInput() {
                const text = dom.input.value.trim();
                if (!text) return;
                addMessageToCanvas({ sender: 'user', text });
                dom.input.value = '';
                processMessage(text);
            }

            function handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    addMessageToCanvas({ sender: 'user', image: e.target.result });
                    processMessage("User uploaded an image."); // Inform the backend
                };
                reader.readAsDataURL(file);
            }
            
            async function processMessage(text) {
                setTyping(true);
                
                // Client-side heuristic for lists
                const lines = text.split('\n').filter(line => line.trim().length > 1);
                if (lines.length > 2) {
                    setTyping(false);
                    showSpinner("מנתח את הרשימה שלך...");
                    const parsed = parsePastedList(text);
                    hideSpinner();
                    addMessageWithOrderPreview(parsed);
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    return;
                }

                // Send message to backend for intelligent response
                try {
                    const response = await apiPost({
                        action: 'handleClientMessage',
                        clientId: state.user['מזהה_לקוח'],
                        text: text
                    });
                    
                    if (response.status === 'success' && response.newMessages) {
                        setTyping(false);
                        response.newMessages.forEach((msg, index) => {
                            setTimeout(() => renderServerMessage(msg), index * 600);
                        });
                    } else {
                         throw new Error(response.message || "Unknown error from server");
                    }
                } catch (e) {
                    setTyping(false);
                    addMessageToCanvas({ sender: 'bot', text: 'הייתה בעיה בתקשורת, נסה שוב.'});
                    console.error("Error processing message:", e);
                }
            }

            function renderServerMessage(msg) {
                const messagePayload = {
                    sender: msg.sender === 'user' ? 'user' : 'bot',
                    text: msg.text,
                    buttons: msg.buttons,
                    seen: true,
                };
                addMessageToCanvas(messagePayload);
            }

            function addMessageToCanvas(message, animate = true) {
                const bubble = document.createElement('div');
                const isUser = message.sender === 'user';
                bubble.className = `message-bubble ${isUser ? 'incoming' : 'outgoing'}`;
                if (!animate) bubble.style.animation = 'none';
                
                let contentHTML = '';
                if(message.text) contentHTML += `<div class="content">${message.text.replace(/\n/g, '<br>')}</div>`;
                if(message.image) contentHTML += `<img src="${message.image}" alt="attachment" class="image-attachment">`;

                if (message.buttons && message.buttons.length > 0) {
                    contentHTML += `<div class="action-buttons">${message.buttons.map(btn => 
                        `<button data-payload="${btn.payload}">${btn.title}</button>`
                    ).join('')}</div>`;
                }

                const timestamp = message.timestamp ? new Date(message.timestamp) : new Date();
                let timestampHTML = `<div class="timestamp">${timestamp.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'})}`;
                if (isUser || message.seen) timestampHTML += `<span class="seen-tick">✓✓</span>`;
                timestampHTML += `</div>`;
                
                bubble.innerHTML = contentHTML + timestampHTML;
                dom.canvas.appendChild(bubble);
                scrollToBottom();
            }

            function addMessageWithOrderPreview(items) {
                const messageId = `msg-${Date.now()}`;
                const bubble = document.createElement('div');
                bubble.className = 'message-bubble outgoing';
                bubble.id = messageId;
                
                const itemsHTML = items.map((item, index) => `
                    <div class="product-item ${item.isUnidentified ? 'unidentified' : ''}">
                        <div class="item-name ${item.isUnidentified ? 'unidentified-item' : ''}">${item.productName} ${item.isUnidentified ? '⚠️' : '✅'}</div>
                        <input type="number" value="${item.quantity}" data-index="${index}" placeholder="כמות">
                        <span>${item.unit || 'יח\''}</span>
                    </div>`).join('');

                bubble.innerHTML = `
                    <div>זיהיתי את הפריטים מהרשימה שלך. נראה תקין?</div>
                    <div class="order-preview-card">
                        <h3>סיכום פריטים</h3>
                        ${itemsHTML}
                        <p style="font-size:0.8rem; color: var(--text-light); margin-top:10px;">⚠️ = פריט לא זוהה מהקטלוג. אנא ודא את השם.</p>
                        <div class="action-buttons">
                            <button class="btn-cancel" data-action="cancel">בטל</button>
                            <button class="btn-confirm" data-action="confirm">אשר ושלח לוואטסאפ</button>
                        </div>
                    </div>
                    <div class="timestamp">${new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'})}</div>`;
                dom.canvas.appendChild(bubble);
                scrollToBottom();
                bubble.querySelector('[data-action="confirm"]').addEventListener('click', () => finalizeOrder(items, messageId));
                bubble.querySelector('[data-action="cancel"]').addEventListener('click', () => {
                     bubble.remove();
                     addMessageToCanvas({ sender: 'bot', text: 'הבנתי, ביטלתי את ניתוח הרשימה. איך תרצה להמשיך?' });
                });
            }

            function finalizeOrder(originalItems, messageId) {
                const confirmedItems = [];
                document.querySelectorAll(`#${messageId} .product-item`).forEach((el, index) => {
                    confirmedItems.push({ ...originalItems[index], quantity: el.querySelector('input').value });
                });
                const itemsList = confirmedItems.map((item, i) => `${i+1}. ${item.productName} - *כמות: ${item.quantity}* ${item.isUnidentified ? '(לא זוהה מהקטלוג)' : ''}`).join('\n');
                const whatsappMessage = encodeURIComponent(`*הזמנה חדשה מאפליקציית ח.סבן 🚀*\n\n*👤 לקוח:* ${state.user['שם_לקוח']}\n*📞 טלפון:* (מספר מהמערכת)\n*🏗️ פרויקט:* (פרויקט ראשי מהמערכת)\n\n*📋 פירוט הזמנה:*\n${itemsList}\n\n--------------------\nנשלח מהאפליקציה החכמה של ח.סבן`);
                const whatsappUrl = `https://wa.me/972508860896?text=${whatsappMessage}`;
                window.open(whatsappUrl, '_blank');
                addMessageToCanvas({ sender: 'bot', text: 'מעולה! פתחתי לך את הוואטסאפ עם ההזמנה המוכנה. רק נשאר לך ללחוץ שלח שם. 👍', seen: true });
            }

            function parsePastedList(text) {
                const lines = text.split('\n').filter(line => line.trim() !== '');
                return lines.map(line => {
                    const match = line.match(/^(.*?)(\d+(\.\d+)?)\s*$/);
                    let productName = line.trim(), quantity = 1;
                    if (match) { productName = match[1].trim(); quantity = parseFloat(match[2]); }
                    const foundProduct = state.productCatalog.find(p => p['שם_מוצר'].toLowerCase().includes(productName.toLowerCase()));
                    return { productName: foundProduct ? foundProduct['שם_מוצר'] : productName, sku: foundProduct ? foundProduct['מק"ט'] : null, quantity, unit: foundProduct ? 'יח' : 'לא ידוע', isUnidentified: !foundProduct };
                });
            }

            function setTyping(isTyping) {
                let indicator = document.getElementById('typing-indicator');
                if (isTyping && !indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'typing-indicator';
                    indicator.className = 'message-bubble typing-indicator';
                    indicator.innerHTML = '<span></span><span></span><span></span>';
                    dom.canvas.appendChild(indicator);
                    scrollToBottom();
                } else if (!isTyping && indicator) {
                    indicator.remove();
                }
            }
            
            function showSpinner(text) { dom.spinnerText.textContent = text; dom.spinner.style.display = 'flex'; }
            function hideSpinner() { dom.spinner.style.display = 'none'; }
            function scrollToBottom() { dom.canvas.scrollTop = dom.canvas.scrollHeight; }
            async function apiPost(body) {
                const response = await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(body) });
                // Since it's no-cors, we can't read the response, but we can assume success if no network error
                // For real debugging, you would need to configure CORS on Apps Script
                // This is a common workaround for simple GAS web apps
                try {
                    // We attempt to read it, but expect it might fail in a no-cors context
                    return await response.json();
                } catch(e) {
                    // For `handleClientMessage`, a successful 'no-cors' call means the script ran.
                    // We'll have to rely on the bot's response to see if it worked.
                    // This is a limitation of the simple setup. A proper backend would solve this.
                    if (body.action === 'handleClientMessage') return {status: 'success', newMessages: [{sender:'bot', text:'קיבלתי, בודק...'}]}; // Fallback
                    return { status: 'success' }; // Assume success for other calls
                }
            }
            
            // Re-fetch `apiPost` for proper JSON parsing with CORS
            async function apiPost(body) {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    redirect: 'follow', // Important for GAS scripts
                    body: JSON.stringify(body),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' } // Required header
                });
                return response.json();
            }

            init();
        });
    </script>
</body>
</html>

