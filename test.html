<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>×”×¢×•×–×¨ ×”××™×©×™ ×œ×”×–×× ×•×ª - ×—.×¡×‘×Ÿ</title>
    <!-- Add other meta tags, links, etc. -->
    <style>
        /* All existing styles remain the same */

        /* --- NEW DIAGNOSTIC STYLES --- */
        #error-toast {
            position: fixed;
            top: -150px; /* Start hidden far above */
            left: 50%;
            transform: translateX(-50%);
            background-color: #d32f2f; /* Red for errors */
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            z-index: 10000;
            transition: top 0.5s cubic-bezier(0.17, 0.84, 0.44, 1); /* Smooth slide in/out */
            font-weight: 600;
            max-width: 90%;
            text-align: center;
            font-family: Assistant, sans-serif;
        }

        #error-toast.success {
            background-color: #2e7d32; /* Green for success messages */
        }
    </style>
</head>
<body>
    <!-- Existing HTML Structure -->
    <div id="app-container">
        <!-- The app content will be dynamically generated here -->
    </div>

    <!-- NEW DIAGNOSTIC ELEMENT -->
    <div id="error-toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Existing configuration (API_URL, etc.) and state variables remain the same

            // --- NEW & UPGRADED DIAGNOSTIC FUNCTIONS ---

            /**
             * Shows a temporary notification at the top of the screen.
             * @param {string} message The message to display.
             * @param {boolean} isSuccess If true, shows a green success message.
             */
            function showToast(message, isSuccess = false) {
                const toast = document.getElementById('error-toast');
                toast.textContent = message;
                toast.className = isSuccess ? 'success' : '';
                toast.style.top = '20px'; // Slide in

                setTimeout(() => {
                    toast.style.top = '-150px'; // Slide out
                }, 5000); // Hide after 5 seconds
            }

            /**
             * The new, robust function for all API communications.
             * Includes detailed logging and specific error handling.
             * @param {object} body The request payload.
             * @returns {Promise<object>} The JSON response from the server.
             */
            async function apiPost(body) {
                console.log('%cğŸš€ Sending API Request:', 'color: #0b72b9; font-weight: bold;', body);
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        redirect: 'follow',
                        body: JSON.stringify(body),
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                    });
                    
                    if (!response.ok) {
                        // Catches server-side errors like 404, 500, etc.
                        throw new Error(`×©×’×™××ª ×©×¨×ª (HTTP ${response.status})`);
                    }

                    const data = await response.json();
                    console.log('%câœ… Received API Response:', 'color: #2e7d32; font-weight: bold;', data);
                    
                    if (data.success === false) {
                        // Catches logical errors returned from the script (e.g., "Client not found")
                         throw new Error(data.message || '×”×©×¨×ª ×”×—×–×™×¨ ×©×’×™××” ×œ× ×¦×¤×•×™×”.');
                    }

                    return data;

                } catch (error) {
                    console.error('%câŒ API Communication Failure:', 'color: #d32f2f; font-weight: bold;', error);
                    
                    let userMessage;
                    // This is the key: Identify the most common failure reason
                    if (error.message.includes('Failed to fetch')) {
                        userMessage = '×›×©×œ ×‘×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª. ×™×™×ª×›×Ÿ ×©×™×© ×‘×¢×™×™×ª ×¨×©×ª ××• ×©×”×¤×¨×™×¡×” ×©×œ ×”×¡×§×¨×™×¤×˜ ××™× ×” ×ª×§×™× ×” (×‘×¢×™×™×ª CORS).';
                    } else {
                        userMessage = error.message;
                    }
                    
                    showToast(userMessage); // Show the specific error to the user
                    throw new Error(userMessage); // Stop execution by re-throwing
                }
            }

            // --- All other existing frontend functions (init, renderMessage, etc.) remain here ---

            // Example of how you could add a connection test button for debugging
            // e.g., in your settings page:
            // document.getElementById('test-connection-btn').addEventListener('click', async () => {
            //     try {
            //         showToast('×‘×•×“×§ ×—×™×‘×•×¨...', true);
            //         const response = await apiPost({ action: 'ping' });
            //         if (response.success) {
            //             showToast('âœ… ×”×—×™×‘×•×¨ ×œ×©×¨×ª ×ª×§×™×Ÿ!', true);
            //         }
            //     } catch (e) { /* Error is already handled by apiPost */ }
            // });

        });
    </script>
</body>
</html>

