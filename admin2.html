<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חמ"ל הזמנות - ח.סבן CRM</title>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f4f7f9; --card: #ffffff;
            --text-dark: #2c3e50; --text-light: #7f8c8d; --border: #e0e4e7;
            --success: #27ae60; --warning: #f39c12; --danger: #e74c3c; --info: #3498db;
            --radius: 12px; --shadow: 0 7px 25px rgba(0,0,0,0.08);
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.7); } 70% { box-shadow: 0 0 0 12px rgba(52, 152, 219, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); } }

        body { font-family: 'Assistant', sans-serif; background-color: var(--bg); color: var(--text-dark); margin: 0; }
        .header { background-color: var(--card); padding: 15px 30px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .header h1 { font-size: 1.8rem; margin: 0; }
        .filters { display: flex; gap: 15px; }
        .filters select { padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; background: #fff; font-family: inherit; }
        
        .main-content { padding: 30px; }
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
        
        .order-card { background-color: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); display: flex; flex-direction: column; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; animation: fadeIn 0.5s ease-out forwards; }
        .order-card:hover { transform: translateY(-5px); box-shadow: 0 12px 30px rgba(0,0,0,0.12); }
        
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; border-bottom: 1px solid var(--border); }
        .card-client { font-size: 1.2rem; font-weight: 700; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; color: #fff; }
        .status-חדש { background-color: var(--info); animation: pulse 2s infinite; }
        .status-בטיפול { background-color: var(--accent); }
        .status-הושלם { background-color: var(--success); }
        
        .card-body { padding: 20px; flex-grow: 1; }
        .last-message { background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-style: italic; color: var(--text-light); }
        .card-details { font-size: 0.9rem; color: var(--text-light); }
        
        .card-actions { background-color: #f8f9fa; padding: 20px; border-top: 1px solid var(--border); border-radius: 0 0 var(--radius) var(--radius); }
        .action-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .action-group select { width: 100%; }
        .reply-group textarea { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 10px; resize: vertical; margin-bottom: 10px; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: inherit; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background-color: var(--brand); color: white; }
        .btn-success { background-color: var(--success); color: white; }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
    </style>
</head>
<body>
    <audio id="notification-sound" src="https://www.zapsplat.com/wp-content/uploads/2015/sound-design/ui_loading_screen_generic_progress_notification_001.mp3" preload="auto"></audio>

    <header class="header">
        <h1>חמ"ל הזמנות</h1>
        <div class="filters">
            <select id="status-filter">
                <option value="all">סינון לפי סטטוס: הכל</option>
                <option value="חדש">חדשות</option>
                <option value="בטיפול">בטיפול</option>
                <option value="הושלם">הושלמו</option>
            </select>
            <button class="btn btn-primary" onclick="loadDashboardData(true)">רענן</button>
        </div>
    </header>

    <main class="main-content">
        <div id="orders-grid" class="orders-grid">
            <p>טוען הזמנות...</p>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- התיקון הקריטי: עדכון כתובת ה-URL ---
            const API_URL = "https://script.google.com/macros/s/AKfycbxidZeDTGtDFhHGsqFlcyxbSmYdPbZnpE3ShTjrdekXIABwjLqvXNYITqHqYxlM890Y/exec";
            
            let allOrders = [];
            let knownOrderIds = new Set();
            const currentUser = "ראמי"; // Mock current user
            const notificationSound = document.getElementById('notification-sound');

            async function apiPost(body) {
                try {
                    const response = await fetch(API_URL, { method: 'POST', mode: 'cors', body: JSON.stringify(body), cache: 'no-cache', headers: { 'Content-Type': 'text/plain;charset=utf-8' } });
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    const result = await response.json();
                    if(result.status === 'error') throw new Error(result.message);
                    return result;
                } catch (error) {
                    console.error("API Error:", error);
                    alert(`שגיאת תקשורת עם השרת: ${error.message}`);
                    return null; // Return null on error to prevent further issues
                }
            }

            window.loadDashboardData = async function(isManualRefresh = false) {
                const grid = document.getElementById('orders-grid');
                if (isManualRefresh) grid.style.opacity = '0.5';

                const data = await apiPost({ action: 'getAdminDashboard' });
                if (data && data.status === 'success') {
                    allOrders = data.conversations;
                    
                    // Check for new orders to play sound
                    const newOrderIds = new Set(allOrders.map(o => o.orderId));
                    if (knownOrderIds.size > 0) {
                        const hasNew = [...newOrderIds].some(id => !knownOrderIds.has(id));
                        if (hasNew) {
                            notificationSound.play().catch(e => console.warn("Could not play notification sound:", e));
                        }
                    }
                    knownOrderIds = newOrderIds;
                    
                    renderOrdersGrid();
                } else {
                    grid.innerHTML = '<p>שגיאה בטעינת נתונים. ודא שהסקריפט פורסם בגרסה חדשה.</p>';
                }
                grid.style.opacity = '1';
            }

            function renderOrdersGrid() {
                const grid = document.getElementById('orders-grid');
                const filter = document.getElementById('status-filter').value;
                const filtered = allOrders.filter(o => filter === 'all' || o.status === filter);
                grid.innerHTML = '';
                if (filtered.length === 0) {
                    grid.innerHTML = '<p>אין הזמנות התואמות לסינון זה.</p>';
                    return;
                }
                filtered.forEach(order => {
                    const card = document.createElement('div');
                    card.className = 'order-card';
                    card.dataset.orderId = order.orderId;
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-client">${order.clientName} (#${order.orderId.substring(4, 8)})</div>
                            <span class="status-badge status-${order.status}">${order.status}</span>
                        </div>
                        <div class="card-body">
                            <div class="last-message">"${order.lastMessage}"</div>
                            <div class="card-details">
                                <strong>עודכן לאחרונה:</strong> ${new Date(order.lastUpdate).toLocaleString('he-IL')}
                                <br>
                                <strong>שויך ל:</strong> ${order.assignedTo || 'טרם שויך'}
                            </div>
                        </div>
                        <div class="card-actions">
                            <div class="action-group">
                                <select class="status-select">
                                    <option value="חדש" ${order.status === 'חדש' ? 'selected' : ''}>חדש</option>
                                    <option value="בטיפול" ${order.status === 'בטיפול' ? 'selected' : ''}>בטיפול</option>
                                    <option value="הושלם" ${order.status === 'הושלם' ? 'selected' : ''}>הושלם</option>
                                </select>
                                <button class="btn btn-primary update-btn">עדכן סטטוס</button>
                            </div>
                            <div class="reply-group">
                                <textarea class="reply-textarea" placeholder="כתוב הודעה אישית ללקוח..."></textarea>
                                <button class="btn btn-success reply-btn">שלח הודעה</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            function setupEventListeners() {
                document.getElementById('status-filter').addEventListener('change', renderOrdersGrid);
                
                // Event delegation for action buttons
                document.getElementById('orders-grid').addEventListener('click', async (e) => {
                    const card = e.target.closest('.order-card');
                    if (!card) return;
                    const orderId = card.dataset.orderId;

                    if (e.target.classList.contains('update-btn')) {
                        const newStatus = card.querySelector('.status-select').value;
                        e.target.textContent = 'מעדכן...';
                        e.target.disabled = true;
                        await apiPost({
                            action: 'updateOrderAndNotify',
                            conversationId: orderId,
                            newStatus: newStatus,
                            updatedBy: currentUser
                        });
                        await loadDashboardData(); // Refresh all data after update
                    }

                    if (e.target.classList.contains('reply-btn')) {
                        const textarea = card.querySelector('.reply-textarea');
                        const message = textarea.value.trim();
                        if (!message) { alert('לא ניתן לשלוח הודעה ריקה.'); return; }
                        
                        e.target.textContent = 'שולח...';
                        e.target.disabled = true;
                        
                        const order = allOrders.find(o => o.orderId === orderId);
                        await apiPost({
                            action: 'adminSendMessage',
                            clientId: order.clientId,
                            orderId: orderId,
                            adminName: currentUser,
                            text: message
                        });
                        textarea.value = '';
                        e.target.textContent = 'שלח הודעה';
                        e.target.disabled = false;
                        alert('ההודעה נשלחה!');
                    }
                });
            }

            function initAdminPanel() {
                loadDashboardData();
                setupEventListeners();
                setInterval(loadDashboardData, 60000); // Auto-refresh every 60 seconds
            }

            initAdminPanel();
        });
    </script>
</body>
</html>

