<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>לוח ניהול הזמנות - ח.סבן</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "acc8a2bc-d54e-4261-b3d2-cc5c5f7b39d3",
      safari_web_id: "web.onesignal.auto.5f4f9ed9-fb2e-4d6a-935d-81aa46fccce0",
      notifyButton: {
        enable: true,
      },
    });
  });
</script>
    <style>
        :root {
            --brand: #0b72b9; --accent: #ff9f1c; --bg: #f0f2f5; --card: #ffffff;
            --text-dark: #1a202c; --text-light: #4a5568; --text-muted: #718096;
            --border: #e2e8f0; --success: #38a169; --warning: #dd6b20; --danger: #e53e3e;
            --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text-dark); direction: rtl; line-height: 1.6; }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: var(--brand); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .header h1 { margin: 0; font-size: 24px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); text-align: center; border-left: 5px solid var(--brand); }
        .stat-number { font-size: 36px; font-weight: 700; color: var(--brand); }
        .stat-label { color: var(--text-muted); font-size: 14px; font-weight: 600; }
        
        .orders-section { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; overflow: hidden; }
        .section-header { background-color: #f8f9fa; border-bottom: 1px solid var(--border); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .section-title { font-size: 18px; font-weight: 700; color: var(--brand); }
        
        .orders-table { width: 100%; border-collapse: collapse; }
        .orders-table th, .orders-table td { padding: 12px 15px; text-align: right; border-bottom: 1px solid var(--border); vertical-align: middle; }
        .orders-table th { background: #f8f9fa; font-weight: 600; color: var(--text-light); text-transform: uppercase; font-size: 12px; }
        .orders-table tr:last-child td { border-bottom: none; }
        .orders-table tr:hover { background: #f7fafc; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; margin: 2px; display: inline-flex; align-items: center; gap: 6px; font-size: 14px; }
        .btn svg { width: 16px; height: 16px; }
        .btn-primary { background: var(--brand); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 700; display: inline-block; }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-processing { background: #fff3e0; color: #f57c00; }
        .status-completed { background: #e8f5e8; color: #388e3c; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5% auto; padding: 25px; border-radius: var(--radius); width: 90%; max-width: 600px; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .close { font-size: 28px; cursor: pointer; color: var(--text-muted); font-weight: 300; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-light); }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 14px; }
        .form-textarea { height: 100px; resize: vertical; }
        
        .notification-badge { background: var(--danger); color: white; border-radius: 50%; width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; margin-left: 8px; font-weight: 700; }
        .tabs { display: flex; border-bottom: 2px solid var(--border); margin-bottom: 20px; }
        .tab { padding: 12px 20px; cursor: pointer; border-bottom: 3px solid transparent; color: var(--text-muted); font-weight: 600; }
        .tab.active { border-bottom-color: var(--brand); font-weight: 700; color: var(--brand); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>לוח ניהול הזמנות - ח.סבן</h1>
            <p>מנהל מחלקת הזמנות</p>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-number" id="total-orders">0</div><div class="stat-label">הזמנות כוללות</div></div>
            <div class="stat-card"><div class="stat-number" id="new-orders">0</div><div class="stat-label">הזמנות חדשות</div></div>
            <div class="stat-card"><div class="stat-number" id="processing-orders">0</div><div class="stat-label">בטיפול</div></div>
            <div class="stat-card"><div class="stat-number" id="completed-orders">0</div><div class="stat-label">הושלמו</div></div>
        </div>
        
        <div class="tabs">
            <div class="tab active" data-tab="materials">הזמנות חומרי בניין</div>
            <div class="tab" data-tab="containers">הזמנות מכולות</div>
        </div>
        
        <div class="tab-content active" id="materials-tab">
            <div class="orders-section">
                <div class="section-header">
                    <div class="section-title">הזמנות חומרי בניין <span class="notification-badge" id="materials-badge">0</span></div>
                    <button class="btn btn-primary" onclick="loadOrders()">רענן</button>
                </div>
                <table class="orders-table"><thead id="materials-orders-head"></thead><tbody id="materials-orders-body"></tbody></table>
            </div>
        </div>
        
        <div class="tab-content" id="containers-tab">
            <div class="orders-section">
                <div class="section-header">
                    <div class="section-title">הזמנות מכולות <span class="notification-badge" id="containers-badge">0</span></div>
                    <button class="btn btn-primary" onclick="loadOrders()">רענן</button>
                </div>
                <table class="orders-table"><thead id="containers-orders-head"></thead><tbody id="containers-orders-body"></tbody></table>
            </div>
        </div>
    </div>
    
    <div id="notification-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>שלח הודעה ללקוח</h2>
                <span class="close" onclick="closeNotificationModal()">&times;</span>
            </div>
            <!-- Hidden input to store the client ID -->
            <input type="hidden" id="notification-client-id">
            <div class="form-group">
                <label class="form-label">לקוח:</label>
                <input type="text" id="notification-client-name" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">כותרת ההודעה:</label>
                <input type="text" id="notification-title" class="form-input" placeholder="לדוגמה: עדכון סטטוס הזמנה">
            </div>
            <div class="form-group">
                <label class="form-label">תוכן ההודעה:</label>
                <textarea id="notification-message" class="form-textarea" placeholder="כתוב כאן את ההודעה ללקוח..."></textarea>
            </div>
            <div style="text-align: left; margin-top: 20px;">
                <button class="btn btn-primary" onclick="sendNotification()">שלח התראה</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzl39GfJSDSdoBr4CwDlg2PWaDQdeoZpTIUclQThhxq88C4IkkkTmrOXif81VvnB7jl/exec";
        let allOrders = [];

        async function apiPost(body) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (data.status === 'error') {
                    throw new Error(data.message);
                }
                return data;
            } catch (error) {
                console.error('API Error:', error);
                alert(`שגיאת תקשורת: ${error.message}`);
                throw error;
            }
        }

        async function loadOrders() {
            const materialsBody = document.getElementById('materials-orders-body');
            const containersBody = document.getElementById('containers-orders-body');
            materialsBody.innerHTML = `<tr><td colspan="7" class="loading">טוען הזמנות...</td></tr>`;
            containersBody.innerHTML = `<tr><td colspan="8" class="loading">טוען הזמנות...</td></tr>`;

            try {
                const data = await apiPost({ action: 'getAdminDashboardData' });
                allOrders = data.orders || [];
                renderTables();
                updateStats();
            } catch (error) {
                materialsBody.innerHTML = `<tr><td colspan="7" class="loading">שגיאה בטעינת הזמנות.</td></tr>`;
                containersBody.innerHTML = `<tr><td colspan="8" class="loading">שגיאה בטעינת הזמנות.</td></tr>`;
            }
        }

        function renderTables() {
            const materialsOrders = allOrders.filter(o => o.orderType === 'materials');
            const containerOrders = allOrders.filter(o => o.orderType === 'container');
            
            renderTable('materials', materialsOrders, ['תאריך קליטה', 'מספר לקוח', 'שם לקוח', 'שם פרויקט', 'פריטים', 'סטטוס', 'פעולות']);
            renderTable('containers', containerOrders, ['תאריך הזמנה', 'מספר לקוח', 'שם לקוח', 'כתובת', 'סוג פעולה', 'סטטוס', 'פעולות']);
        }

        function renderTable(type, data, headers) {
            const head = document.getElementById(`${type}-orders-head`);
            const body = document.getElementById(`${type}-orders-body`);

            head.innerHTML = `<tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr>`;

            if (data.length === 0) {
                body.innerHTML = `<tr><td colspan="${headers.length}" class="loading">אין הזמנות חדשות.</td></tr>`;
                return;
            }

            body.innerHTML = data.map(order => {
                const rowData = {
                    'תאריך קליטה': formatDate(order['תאריך קליטה']),
                    'תאריך הזמנה': formatDate(order['תאריך הזמנה']),
                    'מספר לקוח': order['מספר לקוח'],
                    'שם לקוח': order['שם לקוח'],
                    'שם פרויקט': order['שם פרויקט'],
                    'פריטים': order['פריטים'] ? order['פריטים'].substring(0, 30) + '...' : '---',
                    'כתובת': order['כתובת'],
                    'סוג פעולה': order['סוג פעולה'],
                    'סטטוס': `<span class="status-badge status-${getStatusClass(order['סטטוס'])}">${order['סטטוס']}</span>`,
                    'פעולות': `
                        <button class="btn btn-success" onclick="openNotificationModal('${order['מספר לקוח']}', '${order['שם לקוח']}')">
                           <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" /></svg>
                            שלח התראה
                        </button>
                    `
                };
                return `<tr>${headers.map(h => `<td>${rowData[h] || ''}</td>`).join('')}</tr>`;
            }).join('');
        }

        function updateStats() {
            document.getElementById('total-orders').textContent = allOrders.length;
            const newMaterials = allOrders.filter(o => o.orderType === 'materials' && o['סטטוס'] === 'חדשה').length;
            const newContainers = allOrders.filter(o => o.orderType === 'container' && o['סטטוס'] === 'חדשה').length;
            document.getElementById('new-orders').textContent = newMaterials + newContainers;
            document.getElementById('processing-orders').textContent = allOrders.filter(o => o['סטטוס'] === 'בטיפול').length;
            document.getElementById('completed-orders').textContent = allOrders.filter(o => o['סטטוס'] === 'הושלמה').length;
            document.getElementById('materials-badge').textContent = newMaterials;
            document.getElementById('containers-badge').textContent = newContainers;
        }

        function openNotificationModal(clientId, clientName) {
            document.getElementById('notification-client-id').value = clientId;
            document.getElementById('notification-client-name').value = clientName;
            document.getElementById('notification-modal').style.display = 'block';
        }

        function closeNotificationModal() {
            document.getElementById('notification-modal').style.display = 'none';
        }
        
        async function sendNotification() {
            const clientId = document.getElementById('notification-client-id').value;
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;

            if (!clientId || !title.trim() || !message.trim()) {
                alert('אנא מלא את כל השדות.');
                return;
            }
            
            try {
                const data = await apiPost({
                    action: 'sendNotificationToClient',
                    clientId: clientId,
                    title: title,
                    message: message
                });
                alert(data.message || 'ההתראה נשלחה!');
                closeNotificationModal();
            } catch(error) {
                // The error is already alerted by apiPost
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '---';
            const date = new Date(dateString);
            return date.toLocaleDateString('he-IL', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function getStatusClass(status) {
            if (status === 'חדשה') return 'new';
            if (status === 'בטיפול') return 'processing';
            if (status === 'הושלמה') return 'completed';
            return 'new';
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelector('.tab.active').classList.remove('active');
                    document.querySelector('.tab-content.active').classList.remove('active');
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + '-tab').classList.add('active');
                });
            });
        });

    </script>
</body>
</html>

